<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora Inversa de Cobros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      // lucide is globally available but the structure might be different in UMD build
      // We access icons directly from lucide object in the component to be safe

      // --- Logic ---
      const calculatePrice = (netAmount, method) => {
        if (!netAmount) return 0;

        const base = parseFloat(method.comisionBase) || 0;
        const financ = parseFloat(method.comisionFinanc) || 0;

        // Logic:
        // If incluyeIVA is true: Eff = Base + Financ
        // If incluyeIVA is false: Eff = (Base + Financ) * 1.21
        let effectiveCommission = base + financ;
        if (!method.incluyeIVA) {
          effectiveCommission *= 1.21;
        }

        if (effectiveCommission >= 100) return 0; // Prevent division by zero or negative

        return netAmount / (1 - effectiveCommission / 100);
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
        }).format(amount);
      };

      // --- Initial Data ---
      const initialPaymentMethods = [
        {
          id: 1,
          medioCobro: "NAVE",
          medioPago: "Tarjeta de Crédito",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 4.5,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "Link de Pago NAVE",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
          fecha_ultima_edicion: new Date().toISOString(),
          esPromocion: false,
        },
        {
          id: 2,
          medioCobro: "PayWay",
          medioPago: "Tarjeta de Crédito",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 1.97,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
          fecha_ultima_edicion: new Date().toISOString(),
          esPromocion: false,
        },
      ];

      // --- Components ---

      const LucideIcon = ({ name, size = 20, className = "" }) => {
        // Access global lucide object
        // In some UMD builds, it might be lucide.icons[name] or just lucide[name]
        // We check both
        const Icon =
          window.lucide &&
          (window.lucide.icons
            ? window.lucide.icons[name]
            : window.lucide[name]);

        if (!Icon) {
          console.warn(`Icon ${name} not found`);
          return <span className={className}>{name}</span>;
        }

        const iconRef = React.useRef(null);

        useEffect(() => {
          if (window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons({
              root: iconRef.current ? iconRef.current.parentNode : document,
              nameAttr: "data-lucide",
              attrs: {
                class: className,
                width: size,
                height: size,
              },
            });
          }
        }, [name, size, className]);

        return (
          <i
            ref={iconRef}
            data-lucide={name.toLowerCase()}
            className={className}
            style={{ width: size, height: size, display: "inline-block" }}
          ></i>
        );
      };

      const SelectOrInput = ({
        value,
        onChange,
        options,
        placeholder,
        required = true,
      }) => {
        const [isCustom, setIsCustom] = useState(false);
        const [customValue, setCustomValue] = useState("");

        useEffect(() => {
          // If the current value is not in the options list (and it's not empty), we are in custom mode
          if (value && !options.includes(value)) {
            setIsCustom(true);
            setCustomValue(value);
          } else {
            setIsCustom(false);
          }
        }, [value, options]);

        const handleSelectChange = (e) => {
          const val = e.target.value;
          if (val === "__NEW__") {
            setIsCustom(true);
            setCustomValue("");
            onChange("");
          } else {
            setIsCustom(false);
            onChange(val);
          }
        };

        const handleInputChange = (e) => {
          setCustomValue(e.target.value);
          onChange(e.target.value);
        };

        if (isCustom) {
          return (
            <div className="flex relative">
              <input
                type="text"
                required={required}
                placeholder={placeholder}
                value={customValue}
                onChange={handleInputChange}
                className="w-full p-2 pr-10 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
              />
              <button
                type="button"
                onClick={() => {
                  setIsCustom(false);
                  onChange(options[0] || "");
                }}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                title="Volver a la lista"
              >
                <LucideIcon name="XCircle" size={18} />
              </button>
            </div>
          );
        }

        return (
          <select
            required={required}
            value={value}
            onChange={handleSelectChange}
            className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white appearance-none"
          >
            {value === "" && (
              <option value="" disabled>
                Seleccionar...
              </option>
            )}
            {options.map((opt) => (
              <option key={opt} value={opt}>
                {opt}
              </option>
            ))}
            <option value="__NEW__" className="font-bold text-blue-600">
              ➕ Agregar nuevo...
            </option>
          </select>
        );
      };

      const Header = ({ currentView, onViewChange }) => (
        <header className="flex justify-center border-b bg-white py-4 shadow-sm mb-6 overflow-x-auto">
          <nav className="flex space-x-4 sm:space-x-8 px-4 min-w-max">
            <button
              onClick={() => onViewChange("calculator")}
              className={`flex items-center space-x-2 pb-2 px-2 text-base sm:text-lg font-medium transition-colors ${
                currentView === "calculator"
                  ? "border-b-2 border-blue-600 text-blue-600"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Calculator" size={20} />
              <span>Calculadora</span>
            </button>
            <button
              onClick={() => onViewChange("promotions")}
              className={`flex items-center space-x-2 pb-2 px-2 text-base sm:text-lg font-medium transition-colors ${
                currentView === "promotions"
                  ? "border-b-2 border-purple-600 text-purple-600"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Gift" size={20} />
              <span>Promociones</span>
            </button>
            <button
              onClick={() => onViewChange("notifications")}
              className={`flex items-center space-x-2 pb-2 px-2 text-base sm:text-lg font-medium transition-colors ${
                currentView === "notifications"
                  ? "border-b-2 border-orange-500 text-orange-500"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Bell" size={20} />
              <span>Novedades</span>
            </button>
            <button
              onClick={() => onViewChange("config")}
              className={`flex items-center space-x-2 pb-2 px-2 text-base sm:text-lg font-medium transition-colors ${
                currentView === "config"
                  ? "border-b-2 border-gray-800 text-gray-800"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Settings" size={20} />
              <span>Configuración</span>
            </button>
          </nav>
        </header>
      );

      const ResultCard = ({
        method,
        price,
        effectiveCommission,
        isBestOverall,
        alternatives = [],
      }) => {
        const [showAlternatives, setShowAlternatives] = useState(false);
        const [showInstructions, setShowInstructions] = useState(false);

        // Determine border and background based on highlight type
        let cardClass =
          "relative p-5 rounded-lg border transition-shadow hover:shadow-md bg-white flex flex-col h-full";
        let badgeClass = "";
        let badgeText = "";
        let badgeIcon = null;

        if (isBestOverall) {
          cardClass += " border-green-500 bg-green-50/50";
          badgeClass = "bg-green-100 text-green-700 border-green-300";
          badgeText = "Opción más barata";
          badgeIcon = <LucideIcon name="DollarSign" size={12} className="mr-1" />;
        } else if (method.esPromocion) {
          cardClass += " border-blue-400 bg-blue-50/30";
          badgeClass = "bg-blue-100 text-blue-700 border-blue-200";
          badgeText = "Promo Activa";
          badgeIcon = <LucideIcon name="Gift" size={12} className="mr-1" />;
        } else if (method.cuotas > 1) {
          cardClass += " border-orange-300 bg-orange-50/30";
          badgeClass = "bg-orange-100 text-orange-700 border-orange-200";
          badgeText = "Cuotas";
          badgeIcon = <LucideIcon name="CreditCard" size={12} className="mr-1" />;
        } else {
          cardClass += " border-gray-200";
        }

        const diasSemanaNombres = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];

        return (
          <div className={cardClass}>
            {badgeText && (
              <span
                className={`absolute top-2 right-2 px-2 py-0.5 text-xs font-bold rounded-full border flex items-center ${badgeClass}`}
              >
                {badgeIcon}
                {badgeText}
              </span>
            )}
            <h3 className="font-bold text-gray-900 text-lg mb-1 flex flex-col sm:flex-row sm:items-center pr-24">
              {method.medioCobro}
              <span className="text-sm font-normal text-gray-500 sm:ml-2">
                ({method.medioPago})
              </span>
            </h3>
            <div className="text-sm font-medium text-gray-600 mb-1">
              {method.banco !== "Todos" ? method.banco : "Todos los bancos"}
            </div>

            <div className="mt-2 mb-3 bg-gray-50 p-3 rounded-md border border-gray-100">
              <div className="text-xs text-gray-500 mb-0.5">Monto final a cobrar</div>
              <div className="text-3xl font-bold text-gray-900">
                {price > 0 ? formatCurrency(price) : "$0.00"}
              </div>
              <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                <LucideIcon name="Percent" size={12} />
                Comisión aplicada: <span className="font-semibold text-gray-700">{effectiveCommission.toFixed(2)}%</span>
              </div>
            </div>

            {method.esPromocion && (
              <div className="mb-3 p-2.5 bg-blue-50/80 border border-blue-100 rounded text-sm text-blue-900 flex flex-col gap-1.5">
                <div className="flex items-start gap-2">
                  <LucideIcon
                    name="BadgePercent"
                    size={16}
                    className="text-blue-600 mt-0.5 flex-shrink-0"
                  />
                  <div>
                    <span className="font-bold">
                      {method.porcentaje_descuento_cliente > 0 ? `${method.porcentaje_descuento_cliente}% OFF` : 'Promoción especial'}
                    </span>
                    {method.tope_reintegro > 0 && (
                      <span className="text-blue-700 ml-1">
                        (Tope: ${method.tope_reintegro})
                      </span>
                    )}
                  </div>
                </div>
                <div className="flex items-center gap-2 text-xs text-blue-700 ml-6">
                   <LucideIcon name="CalendarDays" size={12} className="opacity-70" />
                   {method.dias_semana.length < 7
                     ? `Días: ${method.dias_semana.map(d => diasSemanaNombres[d]).join(', ')}`
                     : 'Todos los días'}
                   {method.banco !== "Todos" && <span className="ml-2 font-semibold">· {method.banco}</span>}
                </div>
              </div>
            )}

            <div className="space-y-1.5 mt-auto text-sm text-gray-600">
              <div className="flex items-center gap-2">
                <LucideIcon
                  name="Calendar"
                  size={14}
                  className="text-gray-400"
                />
                <span>
                  Acreditación: <span className="font-medium text-gray-800">{method.diasAcreditacion} días</span>
                </span>
              </div>
              <div className="flex items-center gap-2">
                <LucideIcon
                  name="CreditCard"
                  size={14}
                  className="text-gray-400"
                />
                <span>
                  Cuotas: <span className="font-medium text-gray-800">{method.cuotas}</span>
                </span>
              </div>
            </div>

            {method.instrucciones && (
              <div className="mt-3">
                <button
                  onClick={() => setShowInstructions(!showInstructions)}
                  className="text-xs font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors"
                >
                  {showInstructions ? 'Ocultar instrucciones' : 'Ver instrucciones'}
                  <LucideIcon name={showInstructions ? "ChevronUp" : "ChevronDown"} size={14} />
                </button>
                {showInstructions && (
                  <div className="mt-2 p-2.5 bg-gray-50 border border-gray-200 rounded text-xs text-gray-700 italic">
                    {method.instrucciones}
                  </div>
                )}
              </div>
            )}

            {alternatives.length > 0 && (
              <div className="mt-4 pt-3 border-t border-gray-100 flex flex-col items-center">
                <button
                  onClick={() => setShowAlternatives(!showAlternatives)}
                  className="text-sm font-medium text-gray-500 hover:text-blue-600 transition-colors flex items-center gap-1 w-full justify-center py-1"
                >
                  {showAlternatives ? (
                    <>
                      Ocultar opciones <LucideIcon name="ChevronUp" size={16} />
                    </>
                  ) : (
                    <>
                      Ver {alternatives.length} {alternatives.length === 1 ? 'opción' : 'opciones'} más <LucideIcon name="ChevronDown" size={16} />
                    </>
                  )}
                </button>

                {showAlternatives && (
                  <div className="w-full mt-3 space-y-3">
                    {alternatives.map((alt) => (
                      <div key={alt.method.id} className="bg-gray-50 rounded-lg p-3 border border-gray-200 text-sm">
                        <div className="flex justify-between items-start mb-1">
                          <span className="font-bold text-gray-800">{alt.method.medioCobro}</span>
                          <span className="font-bold text-gray-900">{formatCurrency(alt.price)}</span>
                        </div>
                        <div className="text-gray-500 text-xs mb-2">
                          {alt.method.banco !== "Todos" ? alt.method.banco : "Todos los bancos"}
                        </div>

                        {alt.method.porcentaje_descuento_cliente > 0 && (
                          <div className="mb-2 p-1.5 bg-blue-50/50 border border-blue-100 rounded text-xs text-blue-800 flex items-start gap-1">
                            <LucideIcon name="Tag" size={12} className="text-blue-600 mt-0.5 flex-shrink-0" />
                            <span>
                              <span className="font-bold">{alt.method.porcentaje_descuento_cliente}% OFF</span>
                              {alt.method.tope_reintegro > 0 && ` (Tope: $${alt.method.tope_reintegro})`}
                            </span>
                          </div>
                        )}

                        <div className="grid grid-cols-2 gap-1 text-xs text-gray-600">
                          <div className="flex items-center gap-1">
                            <LucideIcon name="Calendar" size={12} className="text-gray-400" />
                            {alt.method.diasAcreditacion} días
                          </div>
                          <div className="flex items-center gap-1">
                            <LucideIcon name="Percent" size={12} className="text-gray-400" />
                            {alt.effectiveCommission.toFixed(2)}%
                          </div>
                        </div>
                        {alt.method.instrucciones && (
                          <div className="mt-2 text-xs text-gray-500 italic">
                            {alt.method.instrucciones}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        );
      };

      const CalculatorView = ({ methods }) => {
        const [precioBase, setPrecioBase] = useState("");
        const [porcentajeInflado, setPorcentajeInflado] = useState("");

        const [selectedBank, setSelectedBank] = useState("Todos");
        const [isFlexible, setIsFlexible] = useState(false);
        const [selectedCuota, setSelectedCuota] = useState("Todas");
        const [onlyPromosToday, setOnlyPromosToday] = useState(false);
        const [onlyInstallments, setOnlyInstallments] = useState(false);

        const montoNeto = useMemo(() => {
          const base = parseFloat(precioBase) || 0;
          const inflado = parseFloat(porcentajeInflado) || 0;
          if (base <= 0) return 0;
          return base * (1 - inflado / 100);
        }, [precioBase, porcentajeInflado]);

        // Get unique banks
        const banks = useMemo(() => {
          const allBanks = methods.map((m) => m.banco || "Todos");
          return ["Todos", ...new Set(allBanks.filter((b) => b !== "Todos"))];
        }, [methods]);

        const uniqueCuotas = useMemo(() => {
          const cuotas = methods.map((m) => m.cuotas);
          return ["Todas", ...new Set(cuotas)].sort((a, b) => {
            if (a === "Todas") return -1;
            if (b === "Todas") return 1;
            return a - b;
          });
        }, [methods]);

        // Group and calculate results
        const resultsByInstallments = useMemo(() => {
          if (!montoNeto) return {};

          const netAmount = montoNeto;

          const today = new Date();
          const todayStr = today.toISOString().split("T")[0];
          const currentDayOfWeek = today.getDay(); // 0 (Sun) to 6 (Sat)

          // Future dates for flexible search (next 7 days)
          const flexibleDates = [];
          for (let i = 0; i <= 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            flexibleDates.push({
              dateStr: d.toISOString().split("T")[0],
              dayOfWeek: d.getDay(),
            });
          }

          // Filter methods
          const filteredMethods = methods.filter((m) => {
            // 1. Bank filter
            if (
              selectedBank !== "Todos" &&
              m.banco !== "Todos" &&
              m.banco !== selectedBank
            ) {
              return false;
            }

            // 2. Cuotas filter
            if (
              selectedCuota !== "Todas" &&
              m.cuotas.toString() !== selectedCuota.toString()
            ) {
              return false;
            }

            // 3. Date & Vigency filter
            if (isFlexible) {
              // For flexible: Must be valid on at least ONE of the next 7 days
              const validInFuture = flexibleDates.some((fd) => {
                const validDate =
                  (!m.fecha_inicio || m.fecha_inicio <= fd.dateStr) &&
                  (!m.fecha_fin || m.fecha_fin >= fd.dateStr);
                const validDay = m.dias_semana.includes(fd.dayOfWeek);
                return validDate && validDay;
              });
              if (!validInFuture) return false;
            } else {
              // For today: Must be valid strictly today
              const validDate =
                (!m.fecha_inicio || m.fecha_inicio <= todayStr) &&
                (!m.fecha_fin || m.fecha_fin >= todayStr);
              const validDay = m.dias_semana.includes(currentDayOfWeek);
              if (!validDate || !validDay) return false;
            }

            // 4. "Solo promos activas hoy"
            if (onlyPromosToday) {
              if (!m.esPromocion) return false;
              // Even if flexible is on, this checkbox explicitly overrides to "active today"
              const validDate =
                (!m.fecha_inicio || m.fecha_inicio <= todayStr) &&
                (!m.fecha_fin || m.fecha_fin >= todayStr);
              const validDay = m.dias_semana.includes(currentDayOfWeek);
              if (!validDate || !validDay) return false;
            }

            // 5. "Solo cuotas"
            if (onlyInstallments) {
              if (m.cuotas <= 1) return false;
            }

            return true;
          });

          const groupedByCuota = {};
          let overallBestPrice = Infinity;

          filteredMethods.forEach((method) => {
            const price = calculatePrice(netAmount, method);

            // Calculate Effective Commission strictly for display
            const base = parseFloat(method.comisionBase) || 0;
            const financ = parseFloat(method.comisionFinanc) || 0;
            let effectiveCommission = base + financ;
            if (!method.incluyeIVA) {
              effectiveCommission *= 1.21;
            }

            if (price > 0 && price < overallBestPrice) {
              overallBestPrice = price;
            }

            if (!groupedByCuota[method.cuotas]) {
              groupedByCuota[method.cuotas] = [];
            }
            groupedByCuota[method.cuotas].push({ method, price, effectiveCommission });
          });

          // Restructure groups to have one "best" per medioPago and the rest as alternatives
          const finalGrouped = {};

          Object.keys(groupedByCuota).forEach((cuota) => {
            const itemsInCuota = groupedByCuota[cuota];
            // Group by medioPago within the cuota
            const byMedioPago = {};
            itemsInCuota.forEach((item) => {
              const category = item.method.medioPago;
              if (!byMedioPago[category]) byMedioPago[category] = [];
              byMedioPago[category].push(item);
            });

            // For each medioPago, sort by price. First is best, rest are alternatives.
            const categoriesForCuota = [];
            Object.keys(byMedioPago).forEach((category) => {
              const items = byMedioPago[category];
              items.sort((a, b) => a.price - b.price);

              const bestOption = items[0];
              const alternatives = items.slice(1);

              categoriesForCuota.push({
                category,
                bestOption,
                alternatives
              });
            });

            // Sort categories by the best option's price so the cheapest overall appears first
            categoriesForCuota.sort((a, b) => a.bestOption.price - b.bestOption.price);

            // Mark badges on the bestOption of each category
            categoriesForCuota.forEach((catGroup, idx) => {
              const item = catGroup.bestOption;
              item.isBestOverall = Math.abs(item.price - overallBestPrice) < 0.01;
              // Every top-level card is the best in its category, so we mark it if it's not the absolute best
              item.isBestInCategory = !item.isBestOverall;
            });

            finalGrouped[cuota] = categoriesForCuota;
          });

          // Flatten into a single array, sorted by cuotas, then by price
          const flattenedResults = [];
          Object.keys(finalGrouped).sort((a, b) => Number(a) - Number(b)).forEach(cuota => {
            finalGrouped[cuota].forEach(catGroup => {
              flattenedResults.push(catGroup);
            });
          });

          return { flattenedResults, finalGrouped };
        }, [montoNeto, methods, selectedBank, selectedCuota, isFlexible, onlyPromosToday, onlyInstallments]);

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 className="text-2xl font-bold text-gray-800">
                  Calculadora de Precio de Venta
                </h2>
                <div className="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                  <button
                    onClick={() => setIsFlexible(false)}
                    className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${!isFlexible ? "bg-white shadow text-blue-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    Solo Hoy
                  </button>
                  <button
                    onClick={() => setIsFlexible(true)}
                    className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${isFlexible ? "bg-white shadow text-blue-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    Flexible (7 días)
                  </button>
                </div>
              </div>

              <div className="mb-6 flex flex-wrap gap-4 items-center bg-blue-50/50 p-3 rounded-lg border border-blue-100">
                <label className="flex items-center space-x-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={onlyPromosToday}
                    onChange={(e) => setOnlyPromosToday(e.target.checked)}
                    className="w-4 h-4 text-blue-600 rounded border-blue-300 focus:ring-blue-500"
                  />
                  <span className="text-sm font-medium text-blue-800">Solo promos activas hoy</span>
                </label>
                <label className="flex items-center space-x-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={onlyInstallments}
                    onChange={(e) => setOnlyInstallments(e.target.checked)}
                    className="w-4 h-4 text-orange-500 rounded border-orange-300 focus:ring-orange-500"
                  />
                  <span className="text-sm font-medium text-orange-800">Solo cuotas (+1)</span>
                </label>
              </div>

              <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Precio de Lista / Venta
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-3 text-gray-400">
                        $
                      </span>
                      <input
                        type="number"
                        value={precioBase}
                        onChange={(e) => setPrecioBase(e.target.value)}
                        placeholder="Ej: 15000"
                        className="w-full pl-8 pr-4 py-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      % Inflado (Descuento efvo)
                    </label>
                    <div className="relative">
                      <input
                        type="number"
                        value={porcentajeInflado}
                        onChange={(e) => setPorcentajeInflado(e.target.value)}
                        placeholder="Ej: 20"
                        className="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg"
                      />
                      <span className="absolute right-4 top-3 text-gray-400">
                        %
                      </span>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Precio Contado (Monto Neto)
                    </label>
                    <div className="w-full px-4 py-3 bg-gray-200 border border-gray-300 rounded-lg text-lg font-bold text-gray-800 flex items-center justify-between">
                      <span>$</span>
                      <span>
                        {montoNeto > 0
                          ? montoNeto.toLocaleString("es-AR", {
                              minimumFractionDigits: 2,
                              maximumFractionDigits: 2,
                            })
                          : "0,00"}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Cuotas
                  </label>
                  <select
                    value={selectedCuota}
                    onChange={(e) => setSelectedCuota(e.target.value)}
                    className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg appearance-none"
                  >
                    {uniqueCuotas.map((cuota) => (
                      <option key={cuota} value={cuota}>
                        {cuota === "Todas"
                          ? "Todas las cuotas"
                          : `${cuota} cuota(s)`}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Banco del Cliente
                  </label>
                  <select
                    value={selectedBank}
                    onChange={(e) => setSelectedBank(e.target.value)}
                    className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg appearance-none"
                  >
                    {banks.map((bank) => (
                      <option key={bank} value={bank}>
                        {bank}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-stretch">
              {montoNeto > 0 && resultsByInstallments.flattenedResults && resultsByInstallments.flattenedResults.length > 0 && (
                resultsByInstallments.flattenedResults.map((catGroup, idx) => {
                  const item = catGroup.bestOption;
                  return (
                    <ResultCard
                      key={`${item.method.id}-${item.method.cuotas}`}
                      method={item.method}
                      price={item.price}
                      effectiveCommission={item.effectiveCommission}
                      isBestOverall={item.isBestOverall}
                      alternatives={catGroup.alternatives}
                    />
                  );
                })
              )}
            </div>

            {montoNeto > 0 && resultsByInstallments.flattenedResults && resultsByInstallments.flattenedResults.length === 0 && (
              <div className="text-center text-gray-500 py-10 border-2 border-dashed border-gray-200 rounded-xl bg-white mt-4">
                No se encontraron opciones para este filtro.
              </div>
            )}
          </div>
        );
      };

      const ConfigView = ({ methods, onAdd, onEdit, onDelete }) => {
        const [editingId, setEditingId] = useState(null);
        const [formData, setFormData] = useState({
          medioCobro: "",
          medioPago: "",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 0,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
          esPromocion: false,
        });

        const resetForm = () => {
          setFormData({
            medioCobro: "",
            medioPago: "",
            cuotas: 1,
            banco: "Todos",
            comisionBase: 0,
            comisionFinanc: 0,
            incluyeIVA: false,
            diasAcreditacion: 0,
            instrucciones: "",
            fecha_inicio: "",
            fecha_fin: "",
            dias_semana: [0, 1, 2, 3, 4, 5, 6],
            categoriaProducto: "",
            porcentaje_descuento_cliente: 0,
            tope_reintegro: 0,
            tipo_tope: "por_transaccion",
            esPromocion: false,
          });
          setEditingId(null);
        };

        const toggleDia = (diaIndex) => {
          setFormData((prev) => {
            const dias = prev.dias_semana.includes(diaIndex)
              ? prev.dias_semana.filter((d) => d !== diaIndex)
              : [...prev.dias_semana, diaIndex];
            return { ...prev, dias_semana: dias.sort() };
          });
        };

        const diasSemanaNombres = [
          "Dom",
          "Lun",
          "Mar",
          "Mié",
          "Jue",
          "Vie",
          "Sáb",
        ];

        const getVigencyStatus = (method) => {
          const todayStr = new Date().toISOString().split("T")[0];
          const inicio = method.fecha_inicio;
          const fin = method.fecha_fin;

          if (fin && todayStr > fin) {
            return {
              label: "Expirado",
              color: "bg-red-100 text-red-800 border-red-200",
            };
          }

          if (fin) {
            const msPerDay = 1000 * 60 * 60 * 24;
            const todayDate = new Date(todayStr);
            const finDate = new Date(fin);
            const diffDays = Math.ceil((finDate - todayDate) / msPerDay);
            if (diffDays <= 3 && diffDays >= 0) {
              return {
                label: "Próximo a vencer",
                color: "bg-yellow-100 text-yellow-800 border-yellow-200",
              };
            }
          }

          if (inicio && todayStr < inicio) {
            return {
              label: "Programado",
              color: "bg-blue-100 text-blue-800 border-blue-200",
            };
          }

          return {
            label: "Vigente",
            color: "bg-green-100 text-green-800 border-green-200",
          };
        };

        // Aggregate existing options + defaults
        const uniqueOptions = useMemo(() => {
          const defaults = {
            mediosCobro: [
              "NAVE",
              "PayWay",
              "Mercado Pago",
              "Viumi",
              "Getnet",
              "Ualá Bis",
            ],
            mediosPago: [
              "Tarjeta de Crédito",
              "Tarjeta de Débito",
              "Dinero en cuenta",
              "Transferencia",
              "QR",
            ],
            bancos: [
              "Todos",
              "Galicia",
              "Santander",
              "BBVA",
              "Macro",
              "ICBC",
              "Nación",
              "Provincia",
              "Ciudad",
              "Patagonia",
              "Comafi",
            ],
          };

          methods.forEach((m) => {
            if (m.medioCobro && !defaults.mediosCobro.includes(m.medioCobro))
              defaults.mediosCobro.push(m.medioCobro);
            if (m.medioPago && !defaults.mediosPago.includes(m.medioPago))
              defaults.mediosPago.push(m.medioPago);
            if (m.banco && !defaults.bancos.includes(m.banco))
              defaults.bancos.push(m.banco);
          });

          return {
            mediosCobro: defaults.mediosCobro.sort(),
            mediosPago: defaults.mediosPago.sort(),
            bancos: defaults.bancos.sort(),
          };
        }, [methods]);

        const handleSubmit = (e) => {
          e.preventDefault();
          const timestampedData = {
            ...formData,
            fecha_ultima_edicion: new Date().toISOString(),
          };
          if (editingId) {
            onEdit({ ...timestampedData, id: editingId });
          } else {
            onAdd({ ...timestampedData, id: Date.now() });
          }
          resetForm();
        };

        const handleEditClick = (method) => {
          setFormData(method);
          setEditingId(method.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        const handleDuplicateClick = (method) => {
          setFormData({ ...method, id: undefined });
          setEditingId(null);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800">
                  {editingId
                    ? "Editar Medio de Cobro"
                    : "Agregar Nuevo Medio de Cobro"}
                </h2>
                {editingId && (
                  <button
                    onClick={resetForm}
                    className="text-sm text-gray-500 hover:text-gray-700 underline"
                  >
                    Cancelar edición
                  </button>
                )}
              </div>

              <form
                onSubmit={handleSubmit}
                className="grid grid-cols-1 md:grid-cols-2 gap-5"
              >
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Medio de Cobro
                  </label>
                  <SelectOrInput
                    value={formData.medioCobro}
                    onChange={(val) =>
                      setFormData({ ...formData, medioCobro: val })
                    }
                    options={uniqueOptions.mediosCobro}
                    placeholder="Ej: NAVE"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Medio de Pago
                  </label>
                  <SelectOrInput
                    value={formData.medioPago}
                    onChange={(val) =>
                      setFormData({ ...formData, medioPago: val })
                    }
                    options={uniqueOptions.mediosPago}
                    placeholder="Ej: Tarjeta de Crédito"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Cuotas
                  </label>
                  <input
                    required
                    type="number"
                    min="1"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.cuotas}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        cuotas: parseInt(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Banco
                  </label>
                  <SelectOrInput
                    value={formData.banco}
                    onChange={(val) => setFormData({ ...formData, banco: val })}
                    options={uniqueOptions.bancos}
                    placeholder="Ej: Galicia"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Comisión Base (%)
                  </label>
                  <input
                    required
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.comisionBase}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        comisionBase: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Comisión Financ. (%)
                  </label>
                  <input
                    required
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.comisionFinanc}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        comisionFinanc: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Plazo de acreditación (días)
                  </label>
                  <input
                    required
                    type="number"
                    min="0"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.diasAcreditacion}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        diasAcreditacion: parseInt(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1 flex items-center pt-6">
                  <input
                    type="checkbox"
                    id="iva"
                    className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    checked={formData.incluyeIVA}
                    onChange={(e) =>
                      setFormData({ ...formData, incluyeIVA: e.target.checked })
                    }
                  />
                  <label htmlFor="iva" className="ml-2 text-sm text-gray-700">
                    Incluye IVA
                  </label>
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Fecha Inicio (opcional)
                  </label>
                  <input
                    type="date"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.fecha_inicio}
                    onChange={(e) =>
                      setFormData({ ...formData, fecha_inicio: e.target.value })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Fecha Fin (opcional)
                  </label>
                  <input
                    type="date"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.fecha_fin}
                    onChange={(e) =>
                      setFormData({ ...formData, fecha_fin: e.target.value })
                    }
                  />
                </div>

                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Días de la semana vigentes
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {diasSemanaNombres.map((dia, index) => (
                      <button
                        key={dia}
                        type="button"
                        onClick={() => toggleDia(index)}
                        className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                          formData.dias_semana.includes(index)
                            ? "bg-blue-600 text-white"
                            : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                        }`}
                      >
                        {dia}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Categoría/Rubro (opcional)
                  </label>
                  <input
                    type="text"
                    placeholder="Ej: Indumentaria"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.categoriaProducto}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        categoriaProducto: e.target.value,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Descuento Cliente (%)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.porcentaje_descuento_cliente}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        porcentaje_descuento_cliente:
                          parseFloat(e.target.value) || 0,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tope Reintegro ($)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.tope_reintegro}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        tope_reintegro: parseFloat(e.target.value) || 0,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Tope
                  </label>
                  <select
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                    value={formData.tipo_tope}
                    onChange={(e) =>
                      setFormData({ ...formData, tipo_tope: e.target.value })
                    }
                  >
                    <option value="por_transaccion">Por Transacción</option>
                    <option value="por_mes">Por Mes</option>
                  </select>
                </div>

                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Instrucciones (opcional)
                  </label>
                  <input
                    type="text"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.instrucciones}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        instrucciones: e.target.value,
                      })
                    }
                  />
                </div>
                <div className="col-span-2 mt-4 p-4 bg-purple-50 rounded-lg border border-purple-100 flex items-start gap-3">
                  <input
                    type="checkbox"
                    id="esPromocion"
                    checked={formData.esPromocion}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        esPromocion: e.target.checked,
                      })
                    }
                    className="mt-1 w-5 h-5 text-purple-600 rounded border-purple-300 focus:ring-purple-500"
                  />
                  <div>
                    <label
                      htmlFor="esPromocion"
                      className="block text-sm font-bold text-purple-900 mb-1"
                    >
                      Es una promoción destacada
                    </label>
                    <p className="text-xs text-purple-700">
                      Si se marca, esta opción aparecerá en la pestaña de
                      "Promociones" para consultas rápidas.
                    </p>
                  </div>
                </div>

                <div className="col-span-2 mt-2">
                  <button
                    type="submit"
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition-colors"
                  >
                    {editingId ? "Guardar Cambios" : "Agregar Medio de Pago"}
                  </button>
                </div>
              </form>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <h3 className="text-lg font-bold text-gray-800 p-6 border-b">
                Medios Guardados
              </h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-500">
                  <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                      <th className="px-6 py-3">Estado</th>
                      <th className="px-6 py-3">Medio</th>
                      <th className="px-6 py-3">Banco</th>
                      <th className="px-6 py-3">Cuotas</th>
                      <th className="px-6 py-3">Comisión</th>
                      <th className="px-6 py-3">Promoción</th>
                      <th className="px-6 py-3">Actualizado</th>
                      <th className="px-6 py-3 text-right">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {methods.map((method) => {
                      const status = getVigencyStatus(method);
                      return (
                        <tr
                          key={method.id}
                          className="bg-white border-b hover:bg-gray-50"
                        >
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span
                              className={`px-2.5 py-1 text-xs font-semibold rounded-full border ${status.color}`}
                            >
                              {status.label}
                            </span>
                          </td>
                          <td className="px-6 py-4 font-medium text-gray-900">
                            {method.medioCobro} <br />
                            <span className="text-xs text-gray-500 font-normal">
                              {method.medioPago}
                            </span>
                            {method.esPromocion && (
                              <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-purple-100 text-purple-800 border border-purple-200">
                                <LucideIcon
                                  name="Gift"
                                  size={10}
                                  className="mr-1"
                                />{" "}
                                Promo
                              </span>
                            )}
                          </td>
                          <td className="px-6 py-4">{method.banco}</td>
                          <td className="px-6 py-4">{method.cuotas}</td>
                          <td className="px-6 py-4">
                            {method.comisionBase}% + {method.comisionFinanc}%
                            <br />
                            <span className="text-xs text-gray-500">
                              {method.incluyeIVA ? "(Inc. IVA)" : "(+ IVA)"}
                            </span>
                          </td>
                          <td className="px-6 py-4 text-xs">
                            {method.porcentaje_descuento_cliente > 0 && (
                              <div className="text-blue-600 font-medium">
                                -{method.porcentaje_descuento_cliente}% OFF
                                (Tope ${method.tope_reintegro})
                              </div>
                            )}
                            {method.fecha_fin && (
                              <div className="text-gray-500">
                                Hasta:{" "}
                                {new Date(method.fecha_fin).toLocaleDateString(
                                  "es-AR",
                                )}
                              </div>
                            )}
                            {method.dias_semana.length < 7 && (
                              <div className="text-gray-500">
                                Días:{" "}
                                {method.dias_semana
                                  .map((d) => diasSemanaNombres[d])
                                  .join(", ")}
                              </div>
                            )}
                          </td>
                          <td className="px-6 py-4 text-xs text-gray-500 whitespace-nowrap">
                            {method.fecha_ultima_edicion
                              ? new Date(
                                  method.fecha_ultima_edicion,
                                ).toLocaleDateString("es-AR", {
                                  day: "2-digit",
                                  month: "2-digit",
                                  year: "2-digit",
                                })
                              : "-"}
                          </td>
                          <td className="px-6 py-4 text-right">
                            <div className="flex justify-end space-x-1">
                              <button
                                onClick={() => handleDuplicateClick(method)}
                                title="Duplicar"
                                className="p-2 text-gray-500 hover:text-green-600 rounded-full hover:bg-green-50 transition-colors"
                              >
                                <LucideIcon name="Copy" size={16} />
                              </button>
                              <button
                                onClick={() => handleEditClick(method)}
                                title="Editar"
                                className="p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors"
                              >
                                <LucideIcon name="Edit" size={16} />
                              </button>
                              <button
                                onClick={() => onDelete(method.id)}
                                title="Eliminar"
                                className="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-red-50 transition-colors"
                              >
                                <LucideIcon name="Trash2" size={16} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                    {methods.length === 0 && (
                      <tr>
                        <td
                          colSpan="7"
                          className="p-8 text-center text-gray-400"
                        >
                          No hay medios de cobro configurados.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      };

      const PromotionsView = ({ methods }) => {
        const [searchTerm, setSearchTerm] = useState("");
        const [showActive, setShowActive] = useState(true);
        const [showUpcoming, setShowUpcoming] = useState(true);
        const [expandedPromoId, setExpandedPromoId] = useState(null);
        const [viewMode, setViewMode] = useState("list"); // "list" | "calendar"

        const getPromoStatus = (promo) => {
          const todayStr = new Date().toISOString().split("T")[0];
          if (promo.fecha_inicio && promo.fecha_inicio > todayStr) {
            return "upcoming";
          }
          if (promo.fecha_fin && promo.fecha_fin < todayStr) {
            return "expired";
          }
          return "active";
        };

        // Filter valid promotions
        const filteredPromotions = useMemo(() => {
          return methods.filter((m) => {
            if (!m.esPromocion) return false;

            const status = getPromoStatus(m);
            if (status === "expired") return false;

            if (!showActive && status === "active") return false;
            if (!showUpcoming && status === "upcoming") return false;

            if (searchTerm) {
              const term = searchTerm.toLowerCase();
              return (
                (m.banco || "").toLowerCase().includes(term) ||
                (m.medioCobro || "").toLowerCase().includes(term) ||
                (m.medioPago || "").toLowerCase().includes(term)
              );
            }

            return true;
          });
        }, [methods, searchTerm, showActive, showUpcoming]);

        // Group by bank for easier reading
        const promotionsByBank = useMemo(() => {
          const grouped = {};
          filteredPromotions.forEach((p) => {
            const b = p.banco || "Otros";
            if (!grouped[b]) grouped[b] = [];
            grouped[b].push(p);
          });
          // Sort banks alphabetically
          return Object.keys(grouped)
            .sort()
            .reduce((acc, key) => {
              acc[key] = grouped[key];
              return acc;
            }, {});
        }, [filteredPromotions]);

        const diasSemanaNombres = [
          "Dom",
          "Lun",
          "Mar",
          "Mié",
          "Jue",
          "Vie",
          "Sáb",
        ];

        // --- Calendar Logic ---
        const [currentMonth, setCurrentMonth] = useState(() => {
          const now = new Date();
          return new Date(now.getFullYear(), now.getMonth(), 1);
        });

        const calendarDays = useMemo(() => {
          const year = currentMonth.getFullYear();
          const month = currentMonth.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayIndex = new Date(year, month, 1).getDay(); // 0 is Sunday

          const days = [];
          for (let i = 0; i < firstDayIndex; i++) {
            days.push(null); // empty slots for previous month
          }

          for (let i = 1; i <= daysInMonth; i++) {
            // pad with zero for YYYY-MM-DD
            const m = String(month + 1).padStart(2, '0');
            const d = String(i).padStart(2, '0');
            const dateStr = `${year}-${m}-${d}`;

            // Find promos that overlap with this date and are valid on this weekday
            const dateObj = new Date(year, month, i);
            const dayOfWeek = dateObj.getDay();

            const activePromos = methods.filter(promo => {
              if (!promo.esPromocion) return false;

              const startDateValid = !promo.fecha_inicio || promo.fecha_inicio <= dateStr;
              const endDateValid = !promo.fecha_fin || promo.fecha_fin >= dateStr;
              const dayOfWeekValid = promo.dias_semana.includes(dayOfWeek);

              return startDateValid && endDateValid && dayOfWeekValid;
            });

            days.push({ day: i, dateStr, activePromos });
          }
          return days;
        }, [currentMonth, methods]);

        const nextMonth = () => {
          setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
        };
        const prevMonth = () => {
          setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
        };

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                <div className="flex items-center gap-3">
                  <div className="p-3 bg-purple-100 text-purple-600 rounded-lg">
                    <LucideIcon name="Gift" size={24} />
                  </div>
                  <h2 className="text-2xl font-bold text-gray-800">
                    Buscador de Promociones
                  </h2>
                </div>

                <div className="flex bg-gray-100 p-1 rounded-lg">
                  <button
                    onClick={() => setViewMode("list")}
                    className={`flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md transition-all ${viewMode === "list" ? "bg-white shadow text-purple-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    <LucideIcon name="List" size={16} /> Lista
                  </button>
                  <button
                    onClick={() => setViewMode("calendar")}
                    className={`flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md transition-all ${viewMode === "calendar" ? "bg-white shadow text-purple-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    <LucideIcon name="Calendar" size={16} /> Calendario
                  </button>
                </div>
              </div>
              <p className="text-gray-600 mb-6">
                Revisá rápidamente las promociones bancarias vigentes o próximas para ofrecer a los clientes.
              </p>

              {viewMode === "list" && (
                <>
                  <div className="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div className="flex flex-col sm:flex-row gap-4">
                      <div className="flex-grow">
                        <div className="relative">
                          <span className="absolute left-3 top-3 text-gray-400">
                            <LucideIcon name="Search" size={18} />
                          </span>
                          <input
                            type="text"
                            placeholder="Buscar por banco, billetera o medio de pago..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all outline-none"
                          />
                        </div>
                      </div>
                      <div className="flex items-center gap-4 bg-white px-4 py-2 rounded-lg border border-gray-300">
                        <label className="flex items-center space-x-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={showActive}
                            onChange={(e) => setShowActive(e.target.checked)}
                            className="w-4 h-4 text-purple-600 rounded border-purple-300 focus:ring-purple-500"
                          />
                          <span className="text-sm font-medium text-gray-700">Activas</span>
                        </label>
                        <label className="flex items-center space-x-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={showUpcoming}
                            onChange={(e) => setShowUpcoming(e.target.checked)}
                            className="w-4 h-4 text-purple-600 rounded border-purple-300 focus:ring-purple-500"
                          />
                          <span className="text-sm font-medium text-gray-700">Próximas</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  {Object.keys(promotionsByBank).length === 0 ? (
                <div className="text-center py-12 bg-gray-50 rounded-lg border border-gray-200">
                  <LucideIcon
                    name="Tag"
                    size={48}
                    className="mx-auto text-gray-300 mb-3"
                  />
                  <p className="text-gray-500 font-medium">
                    No hay promociones que coincidan con la búsqueda.
                  </p>
                </div>
              ) : (
                <div className="space-y-8">
                  {Object.entries(promotionsByBank).map(([banco, promos]) => (
                    <div
                      key={banco}
                      className="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm"
                    >
                      <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2">
                          <LucideIcon
                            name="Landmark"
                            size={20}
                            className="text-gray-500"
                          />
                          {banco}
                        </h3>
                      </div>
                      <div className="divide-y divide-gray-100">
                        {promos.map((promo) => {
                          const status = getPromoStatus(promo);
                          const isUpcoming = status === "upcoming";
                          const isExpanded = expandedPromoId === promo.id;

                          return (
                            <div
                              key={promo.id}
                              className={`p-4 transition-colors ${isExpanded ? 'bg-purple-50/30' : 'hover:bg-gray-50/50'} cursor-pointer`}
                              onClick={() => setExpandedPromoId(isExpanded ? null : promo.id)}
                            >
                              <div className="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                                <div className="flex-grow">
                                  <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-lg text-gray-900">
                                      {promo.medioCobro}
                                    </span>
                                    <span className="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">
                                      {promo.medioPago}
                                    </span>
                                    {isUpcoming && (
                                      <span className="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full border border-orange-200">
                                        Próximamente
                                      </span>
                                    )}
                                  </div>

                                  <div className="flex flex-col sm:flex-row gap-2 sm:gap-6 mt-2">
                                    {promo.porcentaje_descuento_cliente > 0 && (
                                      <div className="flex flex-col sm:flex-row sm:items-center gap-1.5 text-sm text-green-700 font-medium bg-green-50 px-2 py-1 rounded border border-green-100">
                                        <div className="flex items-center gap-1.5">
                                          <LucideIcon name="BadgePercent" size={16} />
                                          {promo.porcentaje_descuento_cliente}% de reintegro
                                        </div>
                                        {promo.tope_reintegro > 0 && (
                                          <span className="text-xs ml-0 sm:ml-1 opacity-90 border-t sm:border-t-0 sm:border-l border-green-200 pt-1 sm:pt-0 sm:pl-2 mt-1 sm:mt-0">
                                            (Tope: ${promo.tope_reintegro} {promo.tipo_tope === 'por_mes' ? 'por mes' : 'por transacción'})
                                          </span>
                                        )}
                                      </div>
                                    )}
                                    <div className="flex items-center gap-1.5 text-sm text-blue-700 font-medium">
                                      <LucideIcon name="CreditCard" size={16} />
                                      {promo.cuotas} {promo.cuotas === 1 ? "cuota" : "cuotas"}
                                    </div>
                                  </div>
                                </div>

                                <div className={`p-3 rounded-lg border min-w-[200px] text-sm ${isUpcoming ? 'bg-orange-50 border-orange-100 text-orange-900' : 'bg-purple-50 border-purple-100 text-purple-900'}`}>
                                  <div className="font-semibold mb-1 flex items-center gap-1">
                                    <LucideIcon name="CalendarDays" size={14} /> Vigencia:
                                  </div>
                                  {promo.dias_semana.length < 7 ? (
                                    <div className={`ml-5 ${isUpcoming ? 'text-orange-700' : 'text-purple-700'}`}>
                                      Días: {promo.dias_semana.map((d) => diasSemanaNombres[d]).join(", ")}
                                    </div>
                                  ) : (
                                    <div className={`ml-5 ${isUpcoming ? 'text-orange-700' : 'text-purple-700'}`}>
                                      Todos los días
                                    </div>
                                  )}
                                  {promo.fecha_inicio && isUpcoming && (
                                    <div className={`ml-5 font-medium mt-1 ${isUpcoming ? 'text-orange-700' : 'text-purple-700'}`}>
                                      Desde: {new Date(promo.fecha_inicio).toLocaleDateString("es-AR")}
                                    </div>
                                  )}
                                  {promo.fecha_fin && (
                                    <div className={`ml-5 mt-1 ${isUpcoming ? 'text-orange-700' : 'text-purple-700'}`}>
                                      Hasta: {new Date(promo.fecha_fin).toLocaleDateString("es-AR")}
                                    </div>
                                  )}
                                </div>
                              </div>

                              {/* Expandable details area */}
                              {isExpanded && (
                                <div className="mt-4 pt-4 border-t border-purple-100 animate-fadeIn">
                                  <h4 className="font-semibold text-sm text-gray-800 mb-2">Detalles de la Promoción</h4>
                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div className="text-sm text-gray-600 bg-white p-3 rounded border border-gray-100">
                                      <p><span className="font-medium text-gray-700">Comisión del comercio:</span> {promo.comisionBase}% + {promo.comisionFinanc}% {promo.incluyeIVA ? "(Inc. IVA)" : "(+ IVA)"}</p>
                                      <p className="mt-1"><span className="font-medium text-gray-700">Plazo de acreditación:</span> {promo.diasAcreditacion} días</p>
                                      {promo.categoriaProducto && (
                                        <p className="mt-1"><span className="font-medium text-gray-700">Categoría:</span> {promo.categoriaProducto}</p>
                                      )}
                                    </div>
                                    <div className="text-sm text-gray-600 bg-white p-3 rounded border border-gray-100">
                                      <p className="font-medium text-gray-700 mb-1">Instrucciones / Comentarios:</p>
                                      <p className="italic">{promo.instrucciones || "No hay instrucciones adicionales cargadas."}</p>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              )}
              </>
              )}

              {viewMode === "calendar" && (
                <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                  {/* Calendar Header */}
                  <div className="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-200">
                    <button onClick={prevMonth} className="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors">
                      <LucideIcon name="ChevronLeft" size={20} />
                    </button>
                    <h3 className="text-lg font-bold text-gray-800 capitalize">
                      {currentMonth.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' })}
                    </h3>
                    <button onClick={nextMonth} className="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-full transition-colors">
                      <LucideIcon name="ChevronRight" size={20} />
                    </button>
                  </div>

                  {/* Calendar Grid */}
                  <div className="grid grid-cols-7 text-center text-xs sm:text-sm font-semibold text-gray-500 bg-gray-50 border-b border-gray-200">
                    {diasSemanaNombres.map(dia => (
                      <div key={dia} className="py-2">{dia}</div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-px bg-gray-200">
                    {calendarDays.map((dayData, idx) => (
                      <div key={idx} className={`min-h-[80px] sm:min-h-[120px] bg-white p-1 sm:p-2 flex flex-col ${!dayData ? 'opacity-50 bg-gray-50' : ''}`}>
                        {dayData && (
                          <>
                            <div className="text-right text-xs sm:text-sm font-medium text-gray-500 mb-1">{dayData.day}</div>
                            <div className="flex-grow flex flex-col gap-1 overflow-y-auto">
                              {dayData.activePromos.map(promo => {
                                const isStart = promo.fecha_inicio === dayData.dateStr;
                                const isEnd = promo.fecha_fin === dayData.dateStr;
                                return (
                                  <div key={`${promo.id}-${idx}`}
                                    className={`text-[9px] sm:text-[10px] leading-tight p-1 rounded font-medium flex items-center justify-between
                                      ${isStart ? 'bg-green-100 text-green-800 border-l-2 border-green-500' :
                                        isEnd ? 'bg-red-100 text-red-800 border-l-2 border-red-500' :
                                        'bg-purple-50 text-purple-700'}`}
                                    title={`${promo.banco} - ${promo.porcentaje_descuento_cliente}% OFF`}
                                  >
                                    <span className="truncate">{promo.banco}</span>
                                    {isStart && <LucideIcon name="Play" size={10} className="flex-shrink-0" />}
                                    {isEnd && <LucideIcon name="Square" size={10} className="flex-shrink-0" />}
                                  </div>
                                )
                              })}
                            </div>
                          </>
                        )}
                      </div>
                    ))}
                  </div>
                  <div className="p-4 bg-gray-50 border-t border-gray-200 text-xs text-gray-500 flex gap-4 justify-center">
                    <div className="flex items-center gap-1"><span className="w-3 h-3 bg-green-100 border-l-2 border-green-500 rounded-sm inline-block"></span> Inicio Promo</div>
                    <div className="flex items-center gap-1"><span className="w-3 h-3 bg-purple-50 rounded-sm inline-block"></span> Promo Activa</div>
                    <div className="flex items-center gap-1"><span className="w-3 h-3 bg-red-100 border-l-2 border-red-500 rounded-sm inline-block"></span> Fin Promo</div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        const [view, setView] = useState("calculator");
        const [methods, setMethods] = useState(() => {
          const saved = localStorage.getItem("paymentMethods");
          if (!saved) return initialPaymentMethods;

          try {
            const parsed = JSON.parse(saved);
            // Migrate old data to new schema
            return parsed.map((m) => ({
              ...m,
              fecha_inicio: m.fecha_inicio || "",
              fecha_fin: m.fecha_fin || "",
              dias_semana: m.dias_semana || [0, 1, 2, 3, 4, 5, 6],
              categoriaProducto: m.categoriaProducto || "",
              porcentaje_descuento_cliente: m.porcentaje_descuento_cliente || 0,
              tope_reintegro: m.tope_reintegro || 0,
              tipo_tope: m.tipo_tope || "por_transaccion",
              fecha_ultima_edicion:
                m.fecha_ultima_edicion || new Date().toISOString(),
              esPromocion: m.esPromocion || false,
            }));
          } catch (e) {
            console.error("Error parsing saved methods", e);
            return initialPaymentMethods;
          }
        });

        useEffect(() => {
          localStorage.setItem("paymentMethods", JSON.stringify(methods));
        }, [methods]);

        const addMethod = (method) => {
          setMethods([...methods, method]);
        };

        const editMethod = (updatedMethod) => {
          setMethods(
            methods.map((m) => (m.id === updatedMethod.id ? updatedMethod : m)),
          );
        };

        const deleteMethod = (id) => {
          if (confirm("¿Estás seguro de eliminar este medio de cobro?")) {
            setMethods(methods.filter((m) => m.id !== id));
          }
        };

        return (
          <div className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-20">
            <Header currentView={view} onViewChange={setView} />

            {view === "calculator" && <CalculatorView methods={methods} />}
            {view === "promotions" && <PromotionsView methods={methods} />}
            {view === "notifications" && <NotificationsView methods={methods} />}
            {view === "config" && (
              <ConfigView
                methods={methods}
                onAdd={addMethod}
                onEdit={editMethod}
                onDelete={deleteMethod}
              />
            )}
          </div>
        );
      };

      const NotificationsView = ({ methods }) => {
        const todayStr = new Date().toISOString().split("T")[0];
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        const nextWeekStr = nextWeek.toISOString().split("T")[0];

        const nuevasPromos = useMemo(() => {
          return methods.filter(m => {
            if (!m.esPromocion || !m.fecha_inicio) return false;
            return m.fecha_inicio >= todayStr && m.fecha_inicio <= nextWeekStr;
          }).sort((a, b) => a.fecha_inicio.localeCompare(b.fecha_inicio));
        }, [methods, todayStr, nextWeekStr]);

        const promosPorVencer = useMemo(() => {
          return methods.filter(m => {
            if (!m.esPromocion || !m.fecha_fin) return false;
            return m.fecha_fin >= todayStr && m.fecha_fin <= nextWeekStr;
          }).sort((a, b) => a.fecha_fin.localeCompare(b.fecha_fin));
        }, [methods, todayStr, nextWeekStr]);

        const promosVencidas = useMemo(() => {
          const lastWeek = new Date();
          lastWeek.setDate(lastWeek.getDate() - 7);
          const lastWeekStr = lastWeek.toISOString().split("T")[0];

          return methods.filter(m => {
            if (!m.esPromocion || !m.fecha_fin) return false;
            return m.fecha_fin < todayStr && m.fecha_fin >= lastWeekStr;
          }).sort((a, b) => b.fecha_fin.localeCompare(a.fecha_fin)); // Sort descending for expired
        }, [methods, todayStr]);

        const formatShortDate = (dateStr) => {
          if (!dateStr) return "";
          const d = new Date(dateStr);
          // adjust for timezone offset to prevent showing previous day
          d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
          return d.toLocaleDateString("es-AR", { day: 'numeric', month: 'short' });
        };

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-3 bg-orange-100 text-orange-600 rounded-lg">
                  <LucideIcon name="Bell" size={24} />
                </div>
                <h2 className="text-2xl font-bold text-gray-800">
                  Novedades
                </h2>
              </div>
              <p className="text-gray-600 mb-8">
                Consultá al principio del día qué nuevas promociones se activan o cuáles están por vencer.
              </p>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {/* Nuevas Promos */}
                <div>
                  <h3 className="text-lg font-bold text-green-800 mb-4 flex items-center gap-2 border-b border-green-200 pb-2">
                    <LucideIcon name="TrendingUp" size={20} className="text-green-600" />
                    Promociones que inician (próximos 7 días)
                  </h3>

                  {nuevasPromos.length === 0 ? (
                    <div className="p-6 bg-gray-50 rounded-lg border border-gray-100 text-center text-gray-500 text-sm">
                      No hay promociones nuevas programadas para esta semana.
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {nuevasPromos.map(promo => (
                        <div key={promo.id} className="p-3 bg-green-50 rounded-lg border border-green-100 flex justify-between items-start">
                          <div>
                            <div className="font-bold text-gray-900">{promo.medioCobro} <span className="text-sm font-normal text-gray-500">({promo.banco})</span></div>
                            <div className="text-sm text-gray-600 mt-1">{promo.porcentaje_descuento_cliente}% OFF - {promo.cuotas} cuotas</div>
                          </div>
                          <div className="text-right">
                            <span className="inline-block px-2 py-1 bg-green-200 text-green-800 text-xs font-bold rounded">
                              Inicia: {formatShortDate(promo.fecha_inicio)}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Promos por Vencer */}
                <div>
                  <h3 className="text-lg font-bold text-red-800 mb-4 flex items-center gap-2 border-b border-red-200 pb-2">
                    <LucideIcon name="AlertCircle" size={20} className="text-red-600" />
                    Promociones por vencer (próximos 7 días)
                  </h3>

                  {promosPorVencer.length === 0 ? (
                    <div className="p-6 bg-gray-50 rounded-lg border border-gray-100 text-center text-gray-500 text-sm">
                      No hay promociones próximas a vencer esta semana.
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {promosPorVencer.map(promo => (
                        <div key={promo.id} className="p-3 bg-red-50 rounded-lg border border-red-100 flex justify-between items-start">
                          <div>
                            <div className="font-bold text-gray-900">{promo.medioCobro} <span className="text-sm font-normal text-gray-500">({promo.banco})</span></div>
                            <div className="text-sm text-gray-600 mt-1">{promo.porcentaje_descuento_cliente}% OFF - {promo.cuotas} cuotas</div>
                          </div>
                          <div className="text-right">
                            <span className="inline-block px-2 py-1 bg-red-200 text-red-800 text-xs font-bold rounded">
                              Vence: {formatShortDate(promo.fecha_fin)}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Promos Vencidas */}
                <div className="md:col-span-2 mt-4">
                  <h3 className="text-lg font-bold text-gray-500 mb-4 flex items-center gap-2 border-b border-gray-200 pb-2">
                    <LucideIcon name="Archive" size={20} className="text-gray-400" />
                    Promociones vencidas (últimos 7 días)
                  </h3>

                  {promosVencidas.length === 0 ? (
                    <div className="p-6 bg-white rounded-lg border border-gray-100 text-center text-gray-400 text-sm">
                      No hay promociones vencidas recientemente.
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {promosVencidas.map(promo => (
                        <div key={promo.id} className="p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-start opacity-75">
                          <div>
                            <div className="font-bold text-gray-700 line-through">{promo.medioCobro} <span className="text-sm font-normal text-gray-500">({promo.banco})</span></div>
                            <div className="text-sm text-gray-500 mt-1">{promo.porcentaje_descuento_cliente}% OFF - {promo.cuotas} cuotas</div>
                          </div>
                          <div className="text-right">
                            <span className="inline-block px-2 py-1 bg-gray-200 text-gray-600 text-xs font-bold rounded">
                              Venció: {formatShortDate(promo.fecha_fin)}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
