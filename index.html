<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora Inversa de Cobros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      // lucide is globally available but the structure might be different in UMD build
      // We access icons directly from lucide object in the component to be safe

      // --- Logic ---
      const calculatePrice = (netAmount, method) => {
        if (!netAmount) return 0;

        const base = parseFloat(method.comisionBase) || 0;
        const financ = parseFloat(method.comisionFinanc) || 0;

        // Logic:
        // If incluyeIVA is true: Eff = Base + Financ
        // If incluyeIVA is false: Eff = (Base + Financ) * 1.21
        let effectiveCommission = base + financ;
        if (!method.incluyeIVA) {
          effectiveCommission *= 1.21;
        }

        if (effectiveCommission >= 100) return 0; // Prevent division by zero or negative

        return netAmount / (1 - effectiveCommission / 100);
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat("es-AR", {
          style: "currency",
          currency: "ARS",
        }).format(amount);
      };

      // --- Initial Data ---
      const initialPaymentMethods = [
        {
          id: 1,
          medioCobro: "NAVE",
          medioPago: "Tarjeta de Crédito",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 4.5,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "Link de Pago NAVE",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
          fecha_ultima_edicion: new Date().toISOString(),
        },
        {
          id: 2,
          medioCobro: "PayWay",
          medioPago: "Tarjeta de Crédito",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 1.97,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
          fecha_ultima_edicion: new Date().toISOString(),
        },
      ];

      // --- Components ---

      const LucideIcon = ({ name, size = 20, className = "" }) => {
        // Access global lucide object
        // In some UMD builds, it might be lucide.icons[name] or just lucide[name]
        // We check both
        const Icon =
          window.lucide &&
          (window.lucide.icons
            ? window.lucide.icons[name]
            : window.lucide[name]);

        if (!Icon) {
          console.warn(`Icon ${name} not found`);
          return <span className={className}>{name}</span>;
        }

        const iconRef = React.useRef(null);

        useEffect(() => {
          if (window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons({
              root: iconRef.current ? iconRef.current.parentNode : document,
              nameAttr: "data-lucide",
              attrs: {
                class: className,
                width: size,
                height: size,
              },
            });
          }
        }, [name, size, className]);

        return (
          <i
            ref={iconRef}
            data-lucide={name.toLowerCase()}
            className={className}
            style={{ width: size, height: size, display: "inline-block" }}
          ></i>
        );
      };

      const SelectOrInput = ({
        value,
        onChange,
        options,
        placeholder,
        required = true,
      }) => {
        const [isCustom, setIsCustom] = useState(false);
        const [customValue, setCustomValue] = useState("");

        useEffect(() => {
          // If the current value is not in the options list (and it's not empty), we are in custom mode
          if (value && !options.includes(value)) {
            setIsCustom(true);
            setCustomValue(value);
          } else {
            setIsCustom(false);
          }
        }, [value, options]);

        const handleSelectChange = (e) => {
          const val = e.target.value;
          if (val === "__NEW__") {
            setIsCustom(true);
            setCustomValue("");
            onChange("");
          } else {
            setIsCustom(false);
            onChange(val);
          }
        };

        const handleInputChange = (e) => {
          setCustomValue(e.target.value);
          onChange(e.target.value);
        };

        if (isCustom) {
          return (
            <div className="flex relative">
              <input
                type="text"
                required={required}
                placeholder={placeholder}
                value={customValue}
                onChange={handleInputChange}
                className="w-full p-2 pr-10 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
              />
              <button
                type="button"
                onClick={() => {
                  setIsCustom(false);
                  onChange(options[0] || "");
                }}
                className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                title="Volver a la lista"
              >
                <LucideIcon name="XCircle" size={18} />
              </button>
            </div>
          );
        }

        return (
          <select
            required={required}
            value={value}
            onChange={handleSelectChange}
            className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white appearance-none"
          >
            {value === "" && (
              <option value="" disabled>
                Seleccionar...
              </option>
            )}
            {options.map((opt) => (
              <option key={opt} value={opt}>
                {opt}
              </option>
            ))}
            <option value="__NEW__" className="font-bold text-blue-600">
              ➕ Agregar nuevo...
            </option>
          </select>
        );
      };

      const Header = ({ currentView, onViewChange }) => (
        <header className="flex justify-center border-b bg-white py-4 shadow-sm mb-6">
          <nav className="flex space-x-8">
            <button
              onClick={() => onViewChange("calculator")}
              className={`flex items-center space-x-2 pb-2 px-2 text-lg font-medium transition-colors ${
                currentView === "calculator"
                  ? "border-b-2 border-blue-600 text-blue-600"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Calculator" size={20} />
              <span>Calculadora</span>
            </button>
            <button
              onClick={() => onViewChange("config")}
              className={`flex items-center space-x-2 pb-2 px-2 text-lg font-medium transition-colors ${
                currentView === "config"
                  ? "border-b-2 border-blue-600 text-blue-600"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              <LucideIcon name="Settings" size={20} />
              <span>Configuración</span>
            </button>
          </nav>
        </header>
      );

      const ResultCard = ({
        method,
        price,
        effectiveCommission,
        isBestOverall,
        isBestInCategory,
      }) => {
        // Determine border and background based on highlight type
        let cardClass =
          "relative p-5 rounded-lg border transition-shadow hover:shadow-md bg-white flex flex-col h-full";
        let badgeClass = "";
        let badgeText = "";

        if (isBestOverall) {
          cardClass += " border-green-400 bg-green-50";
          badgeClass = "bg-green-100 text-green-700 border-green-200";
          badgeText = "Opción más económica";
        } else if (isBestInCategory) {
          cardClass += " border-yellow-400 bg-yellow-50";
          badgeClass = "bg-yellow-100 text-yellow-800 border-yellow-300";
          badgeText = "Mejor opción en su tipo";
        } else {
          cardClass += " border-gray-200";
        }

        return (
          <div className={cardClass}>
            {(isBestOverall || isBestInCategory) && (
              <span
                className={`absolute top-2 right-2 px-2 py-0.5 text-xs font-bold rounded-full border ${badgeClass}`}
              >
                {badgeText}
              </span>
            )}
            <h3 className="font-bold text-gray-900 text-lg mb-1 flex flex-col sm:flex-row sm:items-center">
              {method.medioCobro}
              <span className="text-sm font-normal text-gray-500 sm:ml-2">
                ({method.medioPago})
              </span>
            </h3>
            <div className="text-sm font-medium text-blue-700 mb-1">
              {method.banco !== "Todos" ? method.banco : "Todos los bancos"}
            </div>
            <div className="text-3xl font-bold text-gray-800 mb-2 mt-1">
              {price > 0 ? formatCurrency(price) : "$0.00"}
            </div>

            {method.porcentaje_descuento_cliente > 0 && (
              <div className="mb-3 p-2 bg-blue-50 border border-blue-100 rounded text-sm text-blue-800 flex items-start gap-2">
                <LucideIcon
                  name="Tag"
                  size={16}
                  className="text-blue-600 mt-0.5 flex-shrink-0"
                />
                <div>
                  <span className="font-bold">
                    {method.porcentaje_descuento_cliente}% de reintegro
                  </span>{" "}
                  para el cliente
                  {method.tope_reintegro > 0 && (
                    <span>
                      {" "}
                      (Tope: ${method.tope_reintegro}{" "}
                      {method.tipo_tope === "por_mes"
                        ? "por mes"
                        : "por transacción"}
                      )
                    </span>
                  )}
                </div>
              </div>
            )}

            <div className="space-y-1 mt-auto">
              <div className="text-sm text-gray-600 flex items-center gap-2">
                <LucideIcon
                  name="Calendar"
                  size={14}
                  className="text-gray-400"
                />
                <span>
                  Plazo de acreditación (días): {method.diasAcreditacion}
                </span>
              </div>
              <div className="text-sm text-gray-600 flex items-center gap-2">
                <LucideIcon
                  name="CreditCard"
                  size={14}
                  className="text-gray-400"
                />
                <span>Cuotas: {method.cuotas}</span>
              </div>
              <div className="text-sm text-gray-600 flex items-center gap-2">
                <LucideIcon
                  name="Percent"
                  size={14}
                  className="text-gray-400"
                />
                <span>Comisión total: {effectiveCommission.toFixed(2)}%</span>
              </div>
            </div>
            {method.instrucciones && (
              <div className="mt-4 pt-3 border-t border-gray-200/50 text-xs text-gray-600 italic">
                {method.instrucciones}
              </div>
            )}
          </div>
        );
      };

      const CalculatorView = ({ methods }) => {
        const [amount, setAmount] = useState("");
        const [selectedBank, setSelectedBank] = useState("Todos");
        const [isFlexible, setIsFlexible] = useState(false);
        const [selectedCuota, setSelectedCuota] = useState("Todas");

        // Get unique banks
        const banks = useMemo(() => {
          const allBanks = methods.map((m) => m.banco || "Todos");
          return ["Todos", ...new Set(allBanks.filter((b) => b !== "Todos"))];
        }, [methods]);

        const uniqueCuotas = useMemo(() => {
          const cuotas = methods.map((m) => m.cuotas);
          return ["Todas", ...new Set(cuotas)].sort((a, b) => {
            if (a === "Todas") return -1;
            if (b === "Todas") return 1;
            return a - b;
          });
        }, [methods]);

        // Group and calculate results
        const resultsByInstallments = useMemo(() => {
          if (!amount) return {};

          const netAmount = parseFloat(amount);

          const today = new Date();
          const todayStr = today.toISOString().split("T")[0];
          const currentDayOfWeek = today.getDay(); // 0 (Sun) to 6 (Sat)

          // Future dates for flexible search (next 7 days)
          const flexibleDates = [];
          for (let i = 0; i <= 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            flexibleDates.push({
              dateStr: d.toISOString().split("T")[0],
              dayOfWeek: d.getDay(),
            });
          }

          // Filter methods
          const filteredMethods = methods.filter((m) => {
            // 1. Bank filter
            if (
              selectedBank !== "Todos" &&
              m.banco !== "Todos" &&
              m.banco !== selectedBank
            ) {
              return false;
            }

            // 2. Cuotas filter
            if (
              selectedCuota !== "Todas" &&
              m.cuotas.toString() !== selectedCuota.toString()
            ) {
              return false;
            }

            // 3. Date & Vigency filter
            if (isFlexible) {
              // For flexible: Must be valid on at least ONE of the next 7 days
              const validInFuture = flexibleDates.some((fd) => {
                const validDate =
                  (!m.fecha_inicio || m.fecha_inicio <= fd.dateStr) &&
                  (!m.fecha_fin || m.fecha_fin >= fd.dateStr);
                const validDay = m.dias_semana.includes(fd.dayOfWeek);
                return validDate && validDay;
              });
              if (!validInFuture) return false;
            } else {
              // For today: Must be valid strictly today
              const validDate =
                (!m.fecha_inicio || m.fecha_inicio <= todayStr) &&
                (!m.fecha_fin || m.fecha_fin >= todayStr);
              const validDay = m.dias_semana.includes(currentDayOfWeek);
              if (!validDate || !validDay) return false;
            }

            return true;
          });

          const grouped = {};
          let overallBestPrice = Infinity;

          filteredMethods.forEach((method) => {
            const price = calculatePrice(netAmount, method);

            // Calculate Effective Commission strictly for display
            const base = parseFloat(method.comisionBase) || 0;
            const financ = parseFloat(method.comisionFinanc) || 0;
            let effectiveCommission = base + financ;
            if (!method.incluyeIVA) {
              effectiveCommission *= 1.21;
            }

            if (price > 0 && price < overallBestPrice) {
              overallBestPrice = price;
            }

            if (!grouped[method.cuotas]) {
              grouped[method.cuotas] = [];
            }
            grouped[method.cuotas].push({ method, price, effectiveCommission });
          });

          // Sort each group by price and identify category bests
          Object.keys(grouped).forEach((cuota) => {
            grouped[cuota].sort((a, b) => a.price - b.price);

            // Track best price per medioPago (category) within this cuota group
            const bestInCategory = {};
            grouped[cuota].forEach((item) => {
              const category = item.method.medioPago;
              if (bestInCategory[category] === undefined) {
                bestInCategory[category] = item.price; // Since it's sorted, the first one encountered is the best
              }

              item.isBestOverall =
                Math.abs(item.price - overallBestPrice) < 0.01;
              // It's the best in category if its price matches the lowest recorded for that category AND it's not already the overall best
              item.isBestInCategory =
                !item.isBestOverall &&
                Math.abs(item.price - bestInCategory[category]) < 0.01;
            });
          });

          return grouped;
        }, [amount, methods, selectedBank]);

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800">
                  Calculadora de Precio de Venta
                </h2>
                <div className="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                  <button
                    onClick={() => setIsFlexible(false)}
                    className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${!isFlexible ? "bg-white shadow text-blue-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    Solo Hoy
                  </button>
                  <button
                    onClick={() => setIsFlexible(true)}
                    className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${isFlexible ? "bg-white shadow text-blue-600" : "text-gray-500 hover:text-gray-700"}`}
                  >
                    Flexible (7 días)
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Monto neto a recibir
                  </label>
                  <div className="relative">
                    <span className="absolute left-3 top-3 text-gray-400">
                      $
                    </span>
                    <input
                      type="number"
                      value={amount}
                      onChange={(e) => setAmount(e.target.value)}
                      placeholder="Ej: 15000"
                      className="w-full pl-8 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Cuotas
                  </label>
                  <select
                    value={selectedCuota}
                    onChange={(e) => setSelectedCuota(e.target.value)}
                    className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg appearance-none"
                  >
                    {uniqueCuotas.map((cuota) => (
                      <option key={cuota} value={cuota}>
                        {cuota === "Todas"
                          ? "Todas las cuotas"
                          : `${cuota} cuota(s)`}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Banco del Cliente
                  </label>
                  <select
                    value={selectedBank}
                    onChange={(e) => setSelectedBank(e.target.value)}
                    className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-lg appearance-none"
                  >
                    {banks.map((bank) => (
                      <option key={bank} value={bank}>
                        {bank}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            </div>

            <div className="space-y-8">
              {Object.keys(resultsByInstallments)
                .sort((a, b) => Number(a) - Number(b))
                .map((cuota) => {
                  const group = resultsByInstallments[cuota];

                  return (
                    <div key={cuota}>
                      <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        En {cuota} cuota(s)
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {group.map((item, idx) => (
                          <ResultCard
                            key={item.method.id}
                            method={item.method}
                            price={item.price}
                            effectiveCommission={item.effectiveCommission}
                            isBestOverall={item.isBestOverall}
                            isBestInCategory={item.isBestInCategory}
                          />
                        ))}
                      </div>
                    </div>
                  );
                })}
              {amount && Object.keys(resultsByInstallments).length === 0 && (
                <div className="text-center text-gray-500 py-10">
                  No se encontraron opciones para este filtro.
                </div>
              )}
            </div>
          </div>
        );
      };

      const ConfigView = ({ methods, onAdd, onEdit, onDelete }) => {
        const [editingId, setEditingId] = useState(null);
        const [formData, setFormData] = useState({
          medioCobro: "",
          medioPago: "",
          cuotas: 1,
          banco: "Todos",
          comisionBase: 0,
          comisionFinanc: 0,
          incluyeIVA: false,
          diasAcreditacion: 0,
          instrucciones: "",
          fecha_inicio: "",
          fecha_fin: "",
          dias_semana: [0, 1, 2, 3, 4, 5, 6],
          categoriaProducto: "",
          porcentaje_descuento_cliente: 0,
          tope_reintegro: 0,
          tipo_tope: "por_transaccion",
        });

        const resetForm = () => {
          setFormData({
            medioCobro: "",
            medioPago: "",
            cuotas: 1,
            banco: "Todos",
            comisionBase: 0,
            comisionFinanc: 0,
            incluyeIVA: false,
            diasAcreditacion: 0,
            instrucciones: "",
            fecha_inicio: "",
            fecha_fin: "",
            dias_semana: [0, 1, 2, 3, 4, 5, 6],
            categoriaProducto: "",
            porcentaje_descuento_cliente: 0,
            tope_reintegro: 0,
            tipo_tope: "por_transaccion",
          });
          setEditingId(null);
        };

        const toggleDia = (diaIndex) => {
          setFormData((prev) => {
            const dias = prev.dias_semana.includes(diaIndex)
              ? prev.dias_semana.filter((d) => d !== diaIndex)
              : [...prev.dias_semana, diaIndex];
            return { ...prev, dias_semana: dias.sort() };
          });
        };

        const diasSemanaNombres = [
          "Dom",
          "Lun",
          "Mar",
          "Mié",
          "Jue",
          "Vie",
          "Sáb",
        ];

        const getVigencyStatus = (method) => {
          const todayStr = new Date().toISOString().split("T")[0];
          const inicio = method.fecha_inicio;
          const fin = method.fecha_fin;

          if (fin && todayStr > fin) {
            return {
              label: "Expirado",
              color: "bg-red-100 text-red-800 border-red-200",
            };
          }

          if (fin) {
            const msPerDay = 1000 * 60 * 60 * 24;
            const todayDate = new Date(todayStr);
            const finDate = new Date(fin);
            const diffDays = Math.ceil((finDate - todayDate) / msPerDay);
            if (diffDays <= 3 && diffDays >= 0) {
              return {
                label: "Próximo a vencer",
                color: "bg-yellow-100 text-yellow-800 border-yellow-200",
              };
            }
          }

          if (inicio && todayStr < inicio) {
            return {
              label: "Programado",
              color: "bg-blue-100 text-blue-800 border-blue-200",
            };
          }

          return {
            label: "Vigente",
            color: "bg-green-100 text-green-800 border-green-200",
          };
        };

        // Aggregate existing options + defaults
        const uniqueOptions = useMemo(() => {
          const defaults = {
            mediosCobro: [
              "NAVE",
              "PayWay",
              "Mercado Pago",
              "Viumi",
              "Getnet",
              "Ualá Bis",
            ],
            mediosPago: [
              "Tarjeta de Crédito",
              "Tarjeta de Débito",
              "Dinero en cuenta",
              "Transferencia",
              "QR",
            ],
            bancos: [
              "Todos",
              "Galicia",
              "Santander",
              "BBVA",
              "Macro",
              "ICBC",
              "Nación",
              "Provincia",
              "Ciudad",
              "Patagonia",
              "Comafi",
            ],
          };

          methods.forEach((m) => {
            if (m.medioCobro && !defaults.mediosCobro.includes(m.medioCobro))
              defaults.mediosCobro.push(m.medioCobro);
            if (m.medioPago && !defaults.mediosPago.includes(m.medioPago))
              defaults.mediosPago.push(m.medioPago);
            if (m.banco && !defaults.bancos.includes(m.banco))
              defaults.bancos.push(m.banco);
          });

          return {
            mediosCobro: defaults.mediosCobro.sort(),
            mediosPago: defaults.mediosPago.sort(),
            bancos: defaults.bancos.sort(),
          };
        }, [methods]);

        const handleSubmit = (e) => {
          e.preventDefault();
          const timestampedData = {
            ...formData,
            fecha_ultima_edicion: new Date().toISOString(),
          };
          if (editingId) {
            onEdit({ ...timestampedData, id: editingId });
          } else {
            onAdd({ ...timestampedData, id: Date.now() });
          }
          resetForm();
        };

        const handleEditClick = (method) => {
          setFormData(method);
          setEditingId(method.id);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };

        return (
          <div className="max-w-4xl mx-auto p-4">
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800">
                  {editingId
                    ? "Editar Medio de Cobro"
                    : "Agregar Nuevo Medio de Cobro"}
                </h2>
                {editingId && (
                  <button
                    onClick={resetForm}
                    className="text-sm text-gray-500 hover:text-gray-700 underline"
                  >
                    Cancelar edición
                  </button>
                )}
              </div>

              <form
                onSubmit={handleSubmit}
                className="grid grid-cols-1 md:grid-cols-2 gap-5"
              >
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Medio de Cobro
                  </label>
                  <SelectOrInput
                    value={formData.medioCobro}
                    onChange={(val) =>
                      setFormData({ ...formData, medioCobro: val })
                    }
                    options={uniqueOptions.mediosCobro}
                    placeholder="Ej: NAVE"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Medio de Pago
                  </label>
                  <SelectOrInput
                    value={formData.medioPago}
                    onChange={(val) =>
                      setFormData({ ...formData, medioPago: val })
                    }
                    options={uniqueOptions.mediosPago}
                    placeholder="Ej: Tarjeta de Crédito"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Cuotas
                  </label>
                  <input
                    required
                    type="number"
                    min="1"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.cuotas}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        cuotas: parseInt(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Banco
                  </label>
                  <SelectOrInput
                    value={formData.banco}
                    onChange={(val) => setFormData({ ...formData, banco: val })}
                    options={uniqueOptions.bancos}
                    placeholder="Ej: Galicia"
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Comisión Base (%)
                  </label>
                  <input
                    required
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.comisionBase}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        comisionBase: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Comisión Financ. (%)
                  </label>
                  <input
                    required
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.comisionFinanc}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        comisionFinanc: parseFloat(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Plazo de acreditación (días)
                  </label>
                  <input
                    required
                    type="number"
                    min="0"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.diasAcreditacion}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        diasAcreditacion: parseInt(e.target.value),
                      })
                    }
                  />
                </div>
                <div className="col-span-1 flex items-center pt-6">
                  <input
                    type="checkbox"
                    id="iva"
                    className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    checked={formData.incluyeIVA}
                    onChange={(e) =>
                      setFormData({ ...formData, incluyeIVA: e.target.checked })
                    }
                  />
                  <label htmlFor="iva" className="ml-2 text-sm text-gray-700">
                    Incluye IVA
                  </label>
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Fecha Inicio (opcional)
                  </label>
                  <input
                    type="date"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.fecha_inicio}
                    onChange={(e) =>
                      setFormData({ ...formData, fecha_inicio: e.target.value })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Fecha Fin (opcional)
                  </label>
                  <input
                    type="date"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.fecha_fin}
                    onChange={(e) =>
                      setFormData({ ...formData, fecha_fin: e.target.value })
                    }
                  />
                </div>

                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Días de la semana vigentes
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {diasSemanaNombres.map((dia, index) => (
                      <button
                        key={dia}
                        type="button"
                        onClick={() => toggleDia(index)}
                        className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                          formData.dias_semana.includes(index)
                            ? "bg-blue-600 text-white"
                            : "bg-gray-100 text-gray-600 hover:bg-gray-200"
                        }`}
                      >
                        {dia}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Categoría/Rubro (opcional)
                  </label>
                  <input
                    type="text"
                    placeholder="Ej: Indumentaria"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.categoriaProducto}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        categoriaProducto: e.target.value,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Descuento Cliente (%)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.porcentaje_descuento_cliente}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        porcentaje_descuento_cliente:
                          parseFloat(e.target.value) || 0,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tope Reintegro ($)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.tope_reintegro}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        tope_reintegro: parseFloat(e.target.value) || 0,
                      })
                    }
                  />
                </div>
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Tope
                  </label>
                  <select
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                    value={formData.tipo_tope}
                    onChange={(e) =>
                      setFormData({ ...formData, tipo_tope: e.target.value })
                    }
                  >
                    <option value="por_transaccion">Por Transacción</option>
                    <option value="por_mes">Por Mes</option>
                  </select>
                </div>

                <div className="col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Instrucciones (opcional)
                  </label>
                  <input
                    type="text"
                    className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.instrucciones}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        instrucciones: e.target.value,
                      })
                    }
                  />
                </div>
                <div className="col-span-2 mt-4">
                  <button
                    type="submit"
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition-colors"
                  >
                    {editingId ? "Guardar Cambios" : "Agregar Medio de Pago"}
                  </button>
                </div>
              </form>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              <h3 className="text-lg font-bold text-gray-800 p-6 border-b">
                Medios Guardados
              </h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-500">
                  <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                      <th className="px-6 py-3">Estado</th>
                      <th className="px-6 py-3">Medio</th>
                      <th className="px-6 py-3">Banco</th>
                      <th className="px-6 py-3">Cuotas</th>
                      <th className="px-6 py-3">Comisión</th>
                      <th className="px-6 py-3">Promoción</th>
                      <th className="px-6 py-3">Actualizado</th>
                      <th className="px-6 py-3 text-right">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {methods.map((method) => {
                      const status = getVigencyStatus(method);
                      return (
                        <tr
                          key={method.id}
                          className="bg-white border-b hover:bg-gray-50"
                        >
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span
                              className={`px-2.5 py-1 text-xs font-semibold rounded-full border ${status.color}`}
                            >
                              {status.label}
                            </span>
                          </td>
                          <td className="px-6 py-4 font-medium text-gray-900">
                            {method.medioCobro} <br />
                            <span className="text-xs text-gray-500 font-normal">
                              {method.medioPago}
                            </span>
                          </td>
                          <td className="px-6 py-4">{method.banco}</td>
                          <td className="px-6 py-4">{method.cuotas}</td>
                          <td className="px-6 py-4">
                            {method.comisionBase}% + {method.comisionFinanc}%
                            <br />
                            <span className="text-xs text-gray-500">
                              {method.incluyeIVA ? "(Inc. IVA)" : "(+ IVA)"}
                            </span>
                          </td>
                          <td className="px-6 py-4 text-xs">
                            {method.porcentaje_descuento_cliente > 0 && (
                              <div className="text-blue-600 font-medium">
                                -{method.porcentaje_descuento_cliente}% OFF
                                (Tope ${method.tope_reintegro})
                              </div>
                            )}
                            {method.fecha_fin && (
                              <div className="text-gray-500">
                                Hasta:{" "}
                                {new Date(method.fecha_fin).toLocaleDateString(
                                  "es-AR",
                                )}
                              </div>
                            )}
                            {method.dias_semana.length < 7 && (
                              <div className="text-gray-500">
                                Días:{" "}
                                {method.dias_semana
                                  .map((d) => diasSemanaNombres[d])
                                  .join(", ")}
                              </div>
                            )}
                          </td>
                          <td className="px-6 py-4 text-xs text-gray-500 whitespace-nowrap">
                            {method.fecha_ultima_edicion
                              ? new Date(
                                  method.fecha_ultima_edicion,
                                ).toLocaleDateString("es-AR", {
                                  day: "2-digit",
                                  month: "2-digit",
                                  year: "2-digit",
                                })
                              : "-"}
                          </td>
                          <td className="px-6 py-4 text-right">
                            <div className="flex justify-end space-x-2">
                              <button
                                onClick={() => handleEditClick(method)}
                                className="p-2 text-gray-500 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors"
                              >
                                <LucideIcon name="Edit" size={18} />
                              </button>
                              <button
                                onClick={() => onDelete(method.id)}
                                className="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-red-50 transition-colors"
                              >
                                <LucideIcon name="Trash2" size={18} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                    {methods.length === 0 && (
                      <tr>
                        <td
                          colSpan="7"
                          className="p-8 text-center text-gray-400"
                        >
                          No hay medios de cobro configurados.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [view, setView] = useState("calculator");
        const [methods, setMethods] = useState(() => {
          const saved = localStorage.getItem("paymentMethods");
          if (!saved) return initialPaymentMethods;

          try {
            const parsed = JSON.parse(saved);
            // Migrate old data to new schema
            return parsed.map((m) => ({
              ...m,
              fecha_inicio: m.fecha_inicio || "",
              fecha_fin: m.fecha_fin || "",
              dias_semana: m.dias_semana || [0, 1, 2, 3, 4, 5, 6],
              categoriaProducto: m.categoriaProducto || "",
              porcentaje_descuento_cliente: m.porcentaje_descuento_cliente || 0,
              tope_reintegro: m.tope_reintegro || 0,
              tipo_tope: m.tipo_tope || "por_transaccion",
              fecha_ultima_edicion:
                m.fecha_ultima_edicion || new Date().toISOString(),
            }));
          } catch (e) {
            console.error("Error parsing saved methods", e);
            return initialPaymentMethods;
          }
        });

        useEffect(() => {
          localStorage.setItem("paymentMethods", JSON.stringify(methods));
        }, [methods]);

        const addMethod = (method) => {
          setMethods([...methods, method]);
        };

        const editMethod = (updatedMethod) => {
          setMethods(
            methods.map((m) => (m.id === updatedMethod.id ? updatedMethod : m)),
          );
        };

        const deleteMethod = (id) => {
          if (confirm("¿Estás seguro de eliminar este medio de cobro?")) {
            setMethods(methods.filter((m) => m.id !== id));
          }
        };

        return (
          <div className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-20">
            <Header currentView={view} onViewChange={setView} />

            {view === "calculator" ? (
              <CalculatorView methods={methods} />
            ) : (
              <ConfigView
                methods={methods}
                onAdd={addMethod}
                onEdit={editMethod}
                onDelete={deleteMethod}
              />
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
